<div class="checkout-container" *ngIf="!isProcessing; else processing">
  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step active">
      <mat-icon>shopping_cart</mat-icon>
      <span>Cart</span>
    </div>
    <div class="step active">
      <mat-icon>location_on</mat-icon>
      <span>Shipping</span>
    </div>
    <div class="step active">
      <mat-icon>payment</mat-icon>
      <span>Payment</span>
    </div>
    <div class="step">
      <mat-icon>check_circle</mat-icon>
      <span>Complete</span>
    </div>
  </div>

  <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-form">
    <!-- Order Summary -->
    <div class="order-summary-section">
      <h2>Order Summary</h2>
      <div class="summary-items">
        <div class="summary-item" *ngFor="let item of orderSummary.items">
          <img [src]="item.product.imageUrl || getDefaultImage(item.product.name)" 
               [alt]="item.product.name" 
               class="summary-item-image"
               (error)="onImageError($event)">
          <div class="summary-item-details">
            <div class="summary-item-name">{{ item.product.name }}</div>
            <div class="summary-item-quantity">Qty: {{ item.quantity }}</div>
            <div class="summary-item-price">${{ item.product.price * item.quantity | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>
      
      <div class="summary-totals">
        <div class="total-row">
          <span>Subtotal:</span>
          <span>${{ orderSummary.subtotal | number:'1.2-2' }}</span>
        </div>
        <div class="total-row">
          <span>Tax (10%):</span>
          <span>${{ orderSummary.tax | number:'1.2-2' }}</span>
        </div>
        <div class="total-row">
          <span>Shipping:</span>
          <span>${{ orderSummary.shipping | number:'1.2-2' }}</span>
        </div>
        <div class="total-row grand-total">
          <span>Total:</span>
          <span>${{ orderSummary.total | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Shipping Information -->
    <div class="shipping-section">
      <h2>Shipping Information</h2>
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Full Name *</mat-label>
          <input matInput formControlName="fullName" placeholder="John Doe">
          <mat-error *ngIf="fullName?.invalid && fullName?.touched">
            Full name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Email Address *</mat-label>
          <input matInput formControlName="email" type="email" placeholder="john@example.com">
          <mat-error *ngIf="email?.invalid && email?.touched">
            Valid email is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Phone Number *</mat-label>
          <input matInput formControlName="phone" placeholder="1234567890">
          <mat-error *ngIf="phone?.invalid && phone?.touched">
            Valid phone number is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Street Address *</mat-label>
          <input matInput formControlName="street" placeholder="123 Main St">
          <mat-error *ngIf="street?.invalid && street?.touched">
            Street address is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>City *</mat-label>
          <input matInput formControlName="city" placeholder="New York">
          <mat-error *ngIf="city?.invalid && city?.touched">
            City is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>State *</mat-label>
          <mat-select formControlName="state">
            <mat-option value="AL">Alabama</mat-option>
            <mat-option value="AK">Alaska</mat-option>
            <mat-option value="AZ">Arizona</mat-option>
            <mat-option value="CA">California</mat-option>
            <mat-option value="FL">Florida</mat-option>
            <mat-option value="NY">New York</mat-option>
            <mat-option value="TX">Texas</mat-option>
          </mat-select>
          <mat-error *ngIf="state?.invalid && state?.touched">
            State is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>ZIP Code *</mat-label>
          <input matInput formControlName="zipCode" placeholder="10001">
          <mat-error *ngIf="zipCode?.invalid && zipCode?.touched">
            Valid ZIP code is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Country *</mat-label>
          <input matInput formControlName="country" placeholder="United States">
          <mat-error *ngIf="country?.invalid && country?.touched">
            Country is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Shipping Options -->
      <div class="shipping-options">
        <h3>Shipping Method</h3>
        <mat-radio-group (change)="onShippingChange()">
          <mat-radio-button *ngFor="let option of shippingOptions" 
                          [value]="option">
            <div class="shipping-option">
              <div class="shipping-name">{{ option.name }}</div>
              <div class="shipping-details">
                <div class="shipping-price">${{ option.price | number:'1.2-2' }}</div>
                <div class="shipping-days">{{ option.days }}</div>
              </div>
            </div>
          </mat-radio-button>
        </mat-radio-group>
      </div>
    </div>

    <!-- Payment Information -->
    <div class="payment-section">
      <h2>Payment Information</h2>
      
      <!-- Payment Method Selection -->
      <div class="payment-methods">
        <mat-radio-group (change)="onPaymentMethodChange($event.value)">
          <mat-radio-button value="credit_card">
            <mat-icon>credit_card</mat-icon>
            Credit Card
          </mat-radio-button>
          <mat-radio-button value="debit_card">
            <mat-icon>credit_card</mat-icon>
            Debit Card
          </mat-radio-button>
          <mat-radio-button value="paypal">
            <mat-icon>account_balance</mat-icon>
            PayPal
          </mat-radio-button>
          <mat-radio-button value="cash_on_delivery">
            <mat-icon>money</mat-icon>
            Cash on Delivery
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Payment Form -->
      <div class="payment-form" *ngIf="showPaymentForm">
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Card Number *</mat-label>
            <input matInput formControlName="cardNumber" 
                   placeholder="1234 5678 9012 3456"
                   (input)="formatCardNumber($event)"
                   maxlength="19">
            <mat-error *ngIf="cardNumber?.invalid && cardNumber?.touched">
              Valid card number is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cardholder Name *</mat-label>
            <input matInput formControlName="cardHolder" placeholder="John Doe">
            <mat-error *ngIf="cardHolder?.invalid && cardHolder?.touched">
              Cardholder name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Expiry Date *</mat-label>
            <input matInput formControlName="expiryDate" 
                   placeholder="MM/YY"
                   (input)="formatExpiryDate($event)"
                   maxlength="5">
            <mat-error *ngIf="expiryDate?.invalid && expiryDate?.touched">
              Valid expiry date is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>CVV *</mat-label>
            <input matInput formControlName="cvv" 
                   placeholder="123"
                   maxlength="4">
            <mat-error *ngIf="cvv?.invalid && cvv?.touched">
              Valid CVV is required
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Billing Address -->
      <div class="billing-address">
        <mat-checkbox formControlName="sameAsShipping" 
                    (change)="onSameAsShippingChange()">
          Same as shipping address
        </mat-checkbox>
        
        <div class="billing-form" *ngIf="!sameAsShipping?.value">
          <h3>Billing Address</h3>
          <div formGroupName="billingAddress" class="form-grid">
            <!-- Same address fields as shipping -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Street Address</mat-label>
              <input matInput formControlName="street">
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>City</mat-label>
              <input matInput formControlName="city">
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>State</mat-label>
              <input matInput formControlName="state">
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>ZIP Code</mat-label>
              <input matInput formControlName="zipCode">
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Notes -->
    <div class="order-notes-section">
      <h2>Order Notes</h2>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Special Instructions</mat-label>
        <textarea matInput formControlName="orderNotes" 
                  placeholder="Any special delivery instructions..."
                  rows="3"></textarea>
      </mat-form-field>
    </div>

    <!-- Action Buttons -->
    <div class="checkout-actions">
      <button mat-button (click)="goBack()" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Back to Cart
      </button>
      
      <button mat-raised-button 
              color="primary" 
              type="submit"
              class="place-order-btn"
              [disabled]="checkoutForm.invalid || isProcessing">
        <mat-icon>shopping_cart</mat-icon>
        Place Order
      </button>
    </div>
  </form>
</div>

<!-- Processing Template -->
<ng-template #processing>
  <div class="processing-container">
    <mat-spinner diameter="60"></mat-spinner>
    <h2>Processing Your Order</h2>
    <p>Please wait while we process your payment and create your order...</p>
    <div class="processing-steps">
      <div class="processing-step active">
        <mat-icon>shopping_cart</mat-icon>
        <span>Validating Order</span>
      </div>
      <div class="processing-step">
        <mat-icon>payment</mat-icon>
        <span>Processing Payment</span>
      </div>
      <div class="processing-step">
        <mat-icon>inventory</mat-icon>
        <span>Creating Order</span>
      </div>
    </div>
  </div>
</ng-template>
